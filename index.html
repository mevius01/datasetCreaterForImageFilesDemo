<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIトレーニング用データZIP作成ツール</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* 全体のフォント、マージン、背景色、文字色を設定します */
        body {
            font-family: 'Inter', sans-serif; /* フォントをInterに変更 */
            margin: 20px;
            background-color: #282c34; /* ダークモードの背景色 */
            color: #e0e0e0; /* 明るい文字色 */
            line-height: 1.6;
        }
        /* コンテナのスタイルを設定し、中央に配置、パディング、背景色、角丸、影を追加します */
        .container {
            max-width: 1200px; /* 幅をさらに広げる */
            margin: 0 auto;
            padding: 30px;
            background-color: #3a3f4a; /* ダークモードのコンテナ背景色 */
            border-radius: 12px; /* 角丸を強調 */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3); /* 影を強調 */
        }
        /* 見出しのスタイルを設定し、色、中央揃え、下マージンを追加します */
        h1, h2 {
            color: #ffffff; /* 明るい見出し色 */
            text-align: center;
            margin-bottom: 25px;
            font-weight: 600; /* 少し太く */
        }
        /* 入力グループ（ラベルと入力フィールドのセット）の下マージンを設定します */
        .input-group {
            margin-bottom: 20px;
        }
        /* ラベルのスタイルを設定し、ブロック表示、下マージン、太字、色を追加します */
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #bbbbbb; /* 明るいラベル色 */
        }
        /* ファイル入力フィールドのスタイルを設定し、ブロック表示、中央マージン、パディング、破線ボーダー、角丸、背景色、カーソルを追加します */
        input[type="file"] {
            display: block;
            margin: 10px auto;
            padding: 10px;
            border: 2px dashed #6a9acb; /* ダークモードに合わせたボーダー色 */
            border-radius: 8px;
            width: fit-content;
            background-color: #4a4f59; /* ダークモードの背景色 */
            color: #e0e0e0; /* 明るい文字色 */
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        input[type="file"]:hover {
            border-color: #8fb8e6; /* ホバー時のボーダー色 */
        }
        /* ファイル選択ボタンのスタイルを設定し、パディング、ボーダーなし、角丸、背景色、文字色、カーソル、トランジションを追加します */
        input[type="file"]::file-selector-button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            background-color: #61afef; /* ダークモードに合わせたボタン色 */
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #529edb;
        }
        /* プレビューセクションの上マージン、上ボーダー、パディング、中央揃えを設定します */
        .preview {
            margin-top: 30px;
            border-top: 1px solid #555; /* ダークモードに合わせたボーダー色 */
            padding-top: 20px;
            text-align: center;
        }
        /* フォルダ指定の説明テキストのスタイル */
        .folder-instruction {
            font-size: 0.95em;
            color: #bbbbbb; /* 明るい文字色 */
            margin-bottom: 15px;
            text-align: left; /* 左寄せ */
            padding: 0 10px; /* 左右に少しパディング */
        }
        .folder-instruction strong {
            color: #ffffff; /* 明るい強調色 */
        }

        /* レイアウトを左右に分割 */
        .main-content {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .left-panel {
            flex: 1; /* 左パネルは残りのスペースを埋める */
            min-width: 300px; /* 最小幅を設定 */
        }
        .right-panel {
            flex: 2; /* 右パネルは左パネルの2倍の幅 */
            min-width: 500px; /* 最小幅を設定 */
            background-color: #3a3f4a;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* 画像リストコンテナのスタイル */
        #image-list-container {
            display: flex;
            flex-direction: column; /* 縦に並べる */
            gap: 15px;
            margin-top: 20px;
            max-height: 500px; /* 高さを制限してスクロール可能にする */
            overflow-y: auto; /* 縦方向のスクロールを有効にする */
            padding-right: 10px; /* スクロールバーのためのスペース */
        }
        /* 各画像アイテムのスタイル */
        .image-item {
            display: flex;
            align-items: flex-start; /* 上揃え */
            gap: 15px;
            padding: 10px;
            border: 1px solid #555; /* ダークモードに合わせたボーダー色 */
            border-radius: 8px;
            background-color: #4a4f59; /* ダークモードの背景色 */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .image-item img {
            width: 60px; /* プレビュー画像のサイズを小さく */
            height: 60px;
            object-fit: cover; /* 画像がボックスを埋めるように */
            border-radius: 4px;
            flex-shrink: 0; /* 縮まないように */
        }
        .image-item .file-details {
            flex-grow: 1; /* 残りのスペースを埋める */
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .image-item .file-details p {
            margin: 0;
            font-size: 0.9em;
            color: #e0e0e0; /* 明るい文字色 */
        }
        .image-item .input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap; /* 小さい画面で折り返す */
        }
        .image-item .input-row label {
            font-size: 0.85em;
            font-weight: bold;
            color: #bbbbbb;
            flex-shrink: 0; /* 縮まないように */
        }
        .image-item .input-row input[type="text"] {
            flex-grow: 1; /* 残りのスペースを埋める */
            min-width: 150px; /* 最小幅 */
            padding: 8px;
            border: 1px solid #777;
            border-radius: 5px;
            font-size: 0.9em;
            box-sizing: border-box;
            background-color: #3a3f4a; /* ダークモードの入力フィールド背景色 */
            color: #e0e0e0; /* 明るい文字色 */
        }
        .image-item .delete-btn {
            background-color: #e06c75; /* ダークモードに合わせた赤色 */
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.9em;
            flex-shrink: 0; /* 縮まないように */
        }
        .image-item .delete-btn:hover {
            background-color: #d15a63;
        }

        /* 一括フォルダ指定セクション */
        .bulk-folder-section {
            padding: 15px;
            background-color: #4a4f59;
            border-radius: 8px;
            border: 1px solid #555;
            margin-bottom: 20px;
        }
        .bulk-folder-section .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px; /* 説明テキストとの間にマージン */
        }
        .bulk-folder-section .input-group input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #777;
            border-radius: 5px;
            background-color: #3a3f4a;
            color: #e0e0e0;
        }
        .bulk-folder-section .input-group button {
            padding: 8px 15px;
            background-color: #61afef;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.9em;
            margin: 0; /* 親のbuttonスタイルを上書き */
            box-shadow: none;
        }
        .bulk-folder-section .input-group button:hover {
            background-color: #529edb;
            transform: none;
        }
        .bulk-folder-section .select-all-checkbox {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-size: 0.9em;
            color: #bbbbbb;
        }
        .bulk-folder-section .select-all-checkbox input[type="checkbox"] {
            margin-right: 8px;
            accent-color: #98c379;
        }


        /* メタデータ項目設定セクション */
        .metadata-column-config {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #555;
        }
        .metadata-column-config .add-column-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .metadata-column-config .add-column-input input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #777;
            border-radius: 5px;
            background-color: #3a3f4a;
            color: #e0e0e0;
        }
        .metadata-column-config .add-column-input button {
            padding: 8px 15px;
            background-color: #61afef;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.9em;
            margin: 0; /* 親のbuttonスタイルを上書き */
            box-shadow: none;
        }
        .metadata-column-config .add-column-input button:hover {
            background-color: #529edb;
            transform: none;
        }
        .metadata-column-config .current-columns {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .metadata-column-config .column-tag {
            background-color: #4a4f59;
            color: #e0e0e0;
            padding: 6px 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85em;
        }
        .metadata-column-config .column-tag .remove-column-btn {
            background: none;
            border: none;
            color: #e06c75;
            font-weight: bold;
            cursor: pointer;
            padding: 0 3px;
            font-size: 1.1em;
            line-height: 1;
            transition: color 0.3s ease;
        }
        .metadata-column-config .column-tag .remove-column-btn:hover {
            color: #d15a63;
        }


        /* メタデータ入力テーブル */
        .metadata-table-container {
            max-height: 400px; /* 高さを制限してスクロール可能に */
            overflow-x: auto; /* 横スクロールを有効に */
            overflow-y: auto; /* 縦スクロールも有効に */
            border: 1px solid #555;
            border-radius: 8px;
            background-color: #3a3f4a;
            margin-top: 20px;
        }
        #metadata-table {
            width: 100%;
            border-collapse: collapse; /* セルの境界線を結合 */
            table-layout: fixed; /* カラム幅を固定 */
        }
        #metadata-table th, #metadata-table td {
            border: 1px solid #555;
            padding: 8px 12px;
            text-align: left;
            white-space: nowrap; /* テキストの折り返しを防止 */
            overflow: hidden;
            text-overflow: ellipsis; /* はみ出したテキストを省略 */
            font-size: 0.9em;
            color: #e0e0e0;
        }
        #metadata-table th {
            background-color: #4a4f59;
            color: #ffffff;
            font-weight: bold;
            position: sticky; /* ヘッダーを固定 */
            top: 0;
            z-index: 10;
        }
        #metadata-table td {
            background-color: #3a3f4a;
        }
        #metadata-table td input[type="text"] {
            width: calc(100% - 16px); /* paddingを考慮 */
            padding: 6px 8px;
            border: 1px solid #777;
            border-radius: 4px;
            background-color: #282c34; /* 入力フィールドの背景色をさらに暗く */
            color: #e0e0e0;
            box-sizing: border-box;
        }
        #metadata-table td.fixed-column {
            background-color: #4a4f59; /* 固定列の背景色を少し変える */
            font-weight: bold;
            color: #ffffff;
        }

        /* ライセンスファイル設定セクション */
        .license-settings {
            margin-top: 30px;
            padding: 20px;
            background-color: #3a3f4a;
            border-radius: 8px;
            border: 1px solid #555;
        }
        .license-settings .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        .license-settings .input-group label {
            margin-bottom: 5px;
        }
        .license-settings select, .license-settings input[type="text"], .license-settings textarea, .license-settings input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #777;
            border-radius: 5px;
            background-color: #282c34;
            color: #e0e0e0;
            box-sizing: border-box;
            font-size: 0.9em;
        }
        .license-settings textarea {
            min-height: 150px;
            resize: vertical; /* 縦方向のみリサイズ可能 */
        }
        .license-settings select {
            appearance: none; /* デフォルトのドロップダウン矢印を非表示 */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23e0e0e0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13%205.1L146.2%20202.7%2018.5%2074.5a17.6%2017.6%200%200%200-25.1%2024.5l130.4%20127.9c6.8%206.7%2017.7%206.7%2024.5%200l130.4-127.9a17.6%2017.6%200%200%200-12.9-29.6z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 12px;
            padding-right: 30px; /* 矢印のためのスペース */
        }
        .license-settings select:focus, .license-settings input[type="text"]:focus, .license-settings textarea:focus, .license-settings input[type="date"]:focus {
            outline: none;
            border-color: #61afef;
            box-shadow: 0 0 0 2px rgba(97, 175, 239, 0.5);
        }
        .license-settings .permission-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #555;
        }
        .license-settings .permission-options h3 {
            color: #ffffff;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .license-settings .permission-options h4 {
            color: #bbbbbb;
            margin-top: 15px;
            margin-bottom: 5px;
            font-size: 1em;
            border-bottom: 1px dashed #666;
            padding-bottom: 5px;
        }
        .license-settings .permission-option {
            display: flex;
            align-items: flex-start; /* チェックボックスとテキストの先頭を揃える */
            font-size: 0.9em;
            color: #e0e0e0;
        }
        .license-settings .permission-option input[type="checkbox"] {
            margin-right: 10px;
            margin-top: 4px; /* テキストのベースラインに合わせる */
            flex-shrink: 0; /* チェックボックスが縮まないように */
            accent-color: #98c379;
            transform: scale(1.1); /* チェックボックスを少し大きく */
        }
        .license-settings .permission-option label {
            margin-bottom: 0; /* 親のlabelスタイルを上書き */
            font-weight: normal;
            display: inline-block;
            flex-grow: 1; /* テキストが残りのスペースを埋めるように */
        }
        .license-settings .permission-option .sub-option {
            margin-left: 30px;
            font-size: 0.85em;
            color: #bbbbbb;
        }
        .license-settings .date-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .license-settings .date-inputs input[type="date"] {
            flex: 1;
        }
        .license-settings .no-duration-checkbox {
            display: flex;
            align-items: center;
            margin-top: 5px;
            font-size: 0.9em;
            color: #bbbbbb;
        }
        .license-settings .no-duration-checkbox input[type="checkbox"] {
            margin-right: 8px;
            accent-color: #98c379;
        }


        /* 情報解析ファイル形式の選択 */
        .metadata-format-selection {
            margin-top: 20px;
            text-align: center;
            padding: 15px;
            background-color: #3a3f4a;
            border-radius: 8px;
            border: 1px solid #555;
        }
        .metadata-format-selection label {
            margin-right: 15px;
            font-weight: bold;
            color: #bbbbbb;
            cursor: pointer;
        }
        .metadata-format-selection input[type="radio"] {
            margin-right: 5px;
            accent-color: #61afef; /* ラジオボタンの色 */
        }

        /* ZIP内容プレビュー */
        .zip-preview {
            margin-top: 30px;
            border-top: 1px solid #555; /* ダークモードに合わせたボーダー色 */
            padding-top: 20px;
        }
        #zip-content-preview {
            list-style: none; /* リストの点を削除 */
            padding: 0;
            text-align: left;
            max-height: 250px; /* 高さを制限してスクロール可能にする */
            overflow-y: auto;
            border: 1px solid #555; /* ダークモードに合わせたボーダー色 */
            border-radius: 8px;
            padding: 10px;
            background-color: #3a3f4a; /* ダークモードの背景色 */
        }
        #zip-content-preview li {
            padding: 5px 0;
            border-bottom: 1px dashed #666; /* ダークモードに合わせた点線ボーダー */
            font-size: 0.9em;
            color: #e0e0e0; /* 明るい文字色 */
            word-break: break-all; /* 長いパスを折り返す */
        }
        #zip-content-preview li:last-child {
            border-bottom: none;
        }
        #zip-content-preview li::before {
            content: '📁 '; /* フォルダアイコン */
            margin-right: 5px;
            color: #f7d046; /* 黄色いフォルダアイコン */
        }
        #zip-content-preview li.metadata-file::before {
            content: '📄 '; /* ファイルアイコン */
            margin-right: 5px;
            color: #61afef; /* 青いファイルアイコン */
        }
        #zip-content-preview li.license-file::before {
            content: '📜 '; /* 巻物アイコン */
            margin-right: 5px;
            color: #e6b450; /* 茶色っぽい巻物アイコン */
        }

        /* 注意事項セクションのスタイル */
        .notes-section {
            margin-top: 40px;
            padding: 25px;
            background-color: #2e323a; /* より暗い背景色 */
            border-radius: 10px;
            border: 1px solid #444;
            color: #bbbbbb;
            font-size: 0.9em;
        }
        .notes-section h2 {
            color: #ffffff;
            margin-top: 0;
            margin-bottom: 15px;
            text-align: left;
        }
        .notes-section ul {
            list-style: disc;
            margin-left: 20px;
            padding-left: 0;
        }
        .notes-section li {
            margin-bottom: 10px;
        }
        .notes-section strong {
            color: #e0e0e0;
        }


        /* ボタンのスタイルを設定し、ブロック表示、中央マージン、パディング、フォントサイズ、背景色、文字色、ボーダーなし、角丸、カーソル、トランジション、影を追加します */
        button {
            display: block;
            margin: 30px auto 10px;
            padding: 12px 25px;
            font-size: 1.1em;
            background-color: #98c379; /* ダークモードに合わせた緑色 */
            color: #282c34; /* 暗い文字色 */
            border: none;
            border-radius: 7px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        /* ボタンのホバー時の背景色と変形を設定します */
        button:hover {
            background-color: #8ab86f;
            transform: translateY(-2px);
        }
        /* 無効化されたボタンのスタイルを設定し、背景色、カーソル、変形、影を無効にします */
        button:disabled {
            background-color: #666666; /* ダークモードの無効化色 */
            color: #aaaaaa;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        /* メッセージ表示エリアのスタイルを設定し、中央揃え、上マージン、太字、色を追加します */
        .message {
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
            color: #bbbbbb; /* 明るい文字色 */
        }
        /* ローディングスピナーのスタイルを設定し、ボーダー、角丸、幅、高さ、アニメーション、初期非表示、中央マージンを追加します */
        .loading-spinner {
            border: 4px solid #4a4f59; /* ダークモードのスピナー背景色 */
            border-top: 4px solid #61afef; /* ダークモードのスピナー色 */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none; /* 初期状態では非表示 */
            margin: 20px auto;
        }
        /* スピナーのアニメーションを定義します */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column; /* 縦並びに変更 */
            }
            .left-panel, .right-panel {
                min-width: unset; /* 最小幅をリセット */
                width: 100%; /* 全幅にする */
            }
            .image-item .input-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .image-item .input-row label {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AIトレーニング用データZIP作成ツール</h1>
        <p>複数の画像ファイルを選択し、それぞれにZIPファイル内の保存パスと追加情報を指定してダウンロードできます。</p>

        <div class="input-group">
            <label for="imageInput">画像ファイルを選択:</label>
            <input type="file" id="imageInput" accept="image/*" multiple>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="bulk-folder-section">
                    <h2>一括フォルダ指定</h2>
                    <div class="input-group">
                        <input type="text" id="bulkFolderPathInput" placeholder="例: my_dataset/images">
                        <button id="applyBulkFolderBtn">適用</button>
                    </div>
                    <small style="color: #bbbbbb;">チェックした画像の「ZIP内パス」を、入力したフォルダパスの直下に配置するように更新します。</small>
                    <div class="select-all-checkbox">
                        <input type="checkbox" id="selectAllImagesCheckbox">
                        <label for="selectAllImagesCheckbox">全て選択 / 全て解除</label>
                    </div>
                </div>

                <div class="preview">
                    <h2>選択された画像とZIP内パス</h2>
                    <p class="folder-instruction">
                        各画像の横にある入力欄で、ZIPファイル内での保存パスを個別に指定できます。<br>
                        フォルダを作成するには、ファイル名の前にフォルダ名とスラッシュ <code>/</code> を入力してください。<br>
                        例: <code>my_folder/image01.jpg</code> (<code>my_folder</code>フォルダ内に保存)<br>
                        例: <code>category_A/sub_category_B/image02.png</code> (ネストされたフォルダ内に保存)<br>
                        入力欄が空の場合、画像はZIPファイルのルートに直接保存されます。
                    </p>
                    <p id="no-image-message" class="message">まだ画像が選択されていません。</p>
                    <div id="image-list-container">
                        </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="metadata-column-config">
                    <h2>情報解析データの項目設定</h2>
                    <p class="message" id="column-config-message"></p>
                    <div class="add-column-input">
                        <input type="text" id="newColumnNameInput" placeholder="新しい項目名 (例: label, category)">
                        <button id="addColumnBtn">項目を追加</button>
                    </div>
                    <div class="current-columns" id="currentColumnsDisplay">
                        </div>
                </div>

                <div class="metadata-input">
                    <h2>情報解析データ入力</h2>
                    <p id="no-metadata-message" class="message">画像を選択すると、ここに表形式の入力欄が表示されます。</p>
                    <div class="metadata-table-container">
                        <table id="metadata-table">
                            </table>
                    </div>
                </div>

                <div class="metadata-format-selection">
                    <h2>情報解析ファイル形式</h2>
                    <input type="radio" id="formatCsv" name="metadataFormat" value="csv" checked>
                    <label for="formatCsv">CSV形式 (.csv)</label>
                    <input type="radio" id="formatTxt" name="metadataFormat" value="txt">
                    <label for="formatTxt">TXT形式 (.txt)</label>
                </div>

                <div class="license-settings">
                    <h2>ライセンスファイル設定</h2>
                    <div class="input-group">
                        <label for="licenseTemplateSelect">ライセンス雛型を選択:</label>
                        <select id="licenseTemplateSelect">
                            <option value="none">ライセンスファイルを含めない</option>
                            <option value="custom">カスタムライセンス</option>
                            <option value="default_paid">デフォルト有料ライセンス</option>
                            <option value="default_free">デフォルト無料ライセンス</option>
                        </select>
                    </div>

                    <div id="providerContactDurationGroup">
                        <div class="input-group" id="datasetProviderGroup">
                            <label for="datasetProviderInput">データセット提供者名/会社名:</label>
                            <input type="text" id="datasetProviderInput" placeholder="例: 株式会社データ提供">
                        </div>
                        <div class="input-group" id="contactInfoGroup">
                            <label for="contactInfoInput">連絡先情報:</label>
                            <input type="text" id="contactInfoInput" placeholder="例: info@example.com">
                        </div>

                        <div class="input-group" id="contractDurationGroup">
                            <label>契約期間:</label>
                            <div class="date-inputs">
                                <input type="date" id="contractStartDate" disabled>
                                <span>〜</span>
                                <input type="date" id="contractEndDate" disabled>
                            </div>
                            <div class="no-duration-checkbox">
                                <input type="checkbox" id="noContractDurationCheckbox" checked>
                                <label for="noContractDurationCheckbox">契約期間を設定しない</label>
                            </div>
                        </div>
                    </div>

                    <div class="input-group" id="freeLicenseOptions" style="display: none;">
                        <label for="freeLicenseSelect">無料ライセンスの選択:</label>
                        <select id="freeLicenseSelect">
                            <option value="mit_license">MITライセンス</option>
                            <option value="apache_license_2_0">Apacheライセンス 2.0</option>
                            <option value="cc_by_4_0">Creative Commons CC BY 4.0</option>
                        </select>
                    </div>

                    <div class="permission-options">
                        <h3>利用許諾内容</h3>
                        <h4>許可事項</h4>
                        <div class="input-group">
                            <label for="aiTrainingPermissionSelect">生成AI学習への利用:</label>
                            <select id="aiTrainingPermissionSelect">
                                <option value="ai_learning">生成AI学習への利用を許可する</option>
                                <option value="ai_analysis">生成AI学習やその他情報解析への利用を許可する</option>
                                <option value="ai_minor_use">生成AI学習やその他情報解析への利用及びその結果を表示するための軽微利用を許可する</option>
                            </select>
                        </div>
                        <div class="permission-option sub-option">
                            <input type="checkbox" id="requireAIAttribution" checked>
                            <label for="requireAIAttribution">生成AI生成物に当該データセットを使用したことを明記することを義務付ける</label>
                        </div>
                        <div class="permission-option">
                            <input type="checkbox" id="allowCommercialUse" checked>
                            <label for="allowCommercialUse">商用利用を許可する</label>
                        </div>
                        <div class="permission-option">
                            <input type="checkbox" id="allowModification" checked>
                            <label for="allowModification">データセットの改変を許可する</label>
                        </div>
                        <div class="permission-option">
                            <input type="checkbox" id="allowRedistribution">
                            <label for="allowRedistribution">データセットの再配布を許可する</label>
                        </div>
                        <div class="permission-option">
                            <input type="checkbox" id="requireServiceCredit">
                            <label for="requireServiceCredit">当該データセットを利用したサービスへのクレジット表記を義務付ける</label>
                        </div>

                        <h4>禁止事項</h4>
                        <div class="permission-option">
                            <input type="checkbox" id="allowNonCommercialUseOnly">
                            <label for="allowNonCommercialUseOnly">非享受利用以外の利用を禁止する</label>
                        </div>
                        <div class="permission-option">
                            <input type="checkbox" id="prohibitReligiousPolitical">
                            <label for="prohibitReligiousPolitical">宗教、政治関係の利用を禁止する</label>
                        </div>
                        <div class="permission-option">
                            <input type="checkbox" id="prohibitEroticGrotesque">
                            <label for="prohibitEroticGrotesque">エロ、グロテスク関係のAI生成への利用を禁止する</label>
                        </div>
                        <div class="permission-option">
                            <input type="checkbox" id="prohibitThirdPartyReproduction">
                            <label for="prohibitThirdPartyReproduction">AI生成物にデータセット内著作物の複製物が含まれていた場合、第三者への提供を禁止する(AI事業者の責任とする)</label>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="licenseContentTextarea">ライセンス内容:</label>
                        <textarea id="licenseContentTextarea" placeholder="デフォルト有料ライセンスやデフォルト無料ライセンスを選択すると自動生成されます。" disabled></textarea>
                    </div>
                    <div class="input-group">
                        <label for="licenseFileNameInput">ライセンスファイル名:</label>
                        <input type="text" id="licenseFileNameInput" value="LICENSE.txt">
                    </div>
                </div>
            </div>
        </div>

        <div class="zip-preview">
            <h2>作成予定のZIPファイル内容</h2>
            <ul id="zip-content-preview">
                </ul>
            <p id="no-zip-content-message" class="message">ZIPファイルの内容はまだありません。</p>
        </div>

        <button id="downloadZipBtn" disabled>ZIPファイルを作成してダウンロード</button>
        <div class="loading-spinner" id="loadingSpinner"></div>
        <p id="status-message" class="message"></p>

        <div class="notes-section">
            <h2>注意事項</h2>
            <ul>
                <li>このツールは画像ファイルのみに対応しています。動画、音声、テキストファイルなど、画像以外のファイルは処理できません。</li>
                <li>大量のファイルを扱う場合、ブラウザのメモリや処理能力の限界により、動作が重くなったり、処理に時間がかかったりする可能性があります。</li>
                <li>このツールは完全にクライアントサイド（お使いのブラウザ内）で動作します。選択された画像ファイルや入力された情報は、いかなるサーバーにも送信されません。これにより、セキュリティとプライバシーは保護されますが、ブラウザのタブを閉じると作業中のデータは失われます。</li>
                <li>自動生成されるライセンスはあくまで一般的なテンプレートです。実際の商用利用や法的な契約においては、専門家（弁護士など）によるレビューを受けることを推奨します。このツールは法的なアドバイスを提供するものではありません。</li>
            </ul>
        </div>
    </div>

    <script>
        // HTML要素をJavaScript変数に格納します
        const imageInput = document.getElementById('imageInput');
        const imageListContainer = document.getElementById('image-list-container');
        const noImageMessage = document.getElementById('no-image-message');
        const zipContentPreview = document.getElementById('zip-content-preview');
        const noZipContentMessage = document.getElementById('no-zip-content-message');
        const downloadZipBtn = document.getElementById('downloadZipBtn');
        const statusMessage = document.getElementById('status-message');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const formatCsvRadio = document.getElementById('formatCsv');
        const formatTxtRadio = document.getElementById('formatTxt');

        // メタデータ項目設定関連の要素
        const newColumnNameInput = document.getElementById('newColumnNameInput');
        const addColumnBtn = document.getElementById('addColumnBtn');
        const currentColumnsDisplay = document.getElementById('currentColumnsDisplay');
        const columnConfigMessage = document.getElementById('column-config-message');

        // メタデータ入力テーブル関連の要素
        const metadataTable = document.getElementById('metadata-table');
        const noMetadataMessage = document.getElementById('no-metadata-message');

        // 一括フォルダ指定関連の要素
        const bulkFolderPathInput = document.getElementById('bulkFolderPathInput');
        const applyBulkFolderBtn = document.getElementById('applyBulkFolderBtn');
        const selectAllImagesCheckbox = document.getElementById('selectAllImagesCheckbox'); // 全て選択/解除チェックボックス

        // ライセンス設定関連の要素
        const licenseTemplateSelect = document.getElementById('licenseTemplateSelect');
        const licenseContentTextarea = document.getElementById('licenseContentTextarea');
        const licenseFileNameInput = document.getElementById('licenseFileNameInput');

        // 新しく追加された要素
        const freeLicenseSelect = document.getElementById('freeLicenseSelect');
        const freeLicenseOptionsDiv = document.getElementById('freeLicenseOptions');
        const providerContactDurationGroup = document.getElementById('providerContactDurationGroup');
        const datasetProviderGroup = document.getElementById('datasetProviderGroup'); // データセット提供者名/会社名のグループ
        const contactInfoGroup = document.getElementById('contactInfoGroup'); // 連絡先情報のグループ
        const contractDurationGroup = document.getElementById('contractDurationGroup'); // 契約期間のグループ


        // 利用許諾内容チェックボックス
        const aiTrainingPermissionSelect = document.getElementById('aiTrainingPermissionSelect'); // 新しいドロップダウン
        const requireAIAttributionCheckbox = document.getElementById('requireAIAttribution');
        const allowCommercialUseCheckbox = document.getElementById('allowCommercialUse');
        const allowRedistributionCheckbox = document.getElementById('allowRedistribution');
        const allowModificationCheckbox = document.getElementById('allowModification');
        const allowNonCommercialUseOnlyCheckbox = document.getElementById('allowNonCommercialUseOnly'); // 非享受利用のみ
        const requireServiceCreditCheckbox = document.getElementById('requireServiceCredit'); // サービスへのクレジット表記義務
        const prohibitReligiousPoliticalCheckbox = document.getElementById('prohibitReligiousPolitical'); // 宗教、政治関係の利用禁止
        const prohibitEroticGrotesqueCheckbox = document.getElementById('prohibitEroticGrotesque'); // エロ、グロテスク関係のAI生成利用禁止
        const prohibitThirdPartyReproductionCheckbox = document.getElementById('prohibitThirdPartyReproduction'); // AI生成物複製物の第三者提供禁止

        const permissionOptionsDiv = document.querySelector('.permission-options');

        // 新しく追加されたライセンス関連の要素
        const datasetProviderInput = document.getElementById('datasetProviderInput');
        const contactInfoInput = document.getElementById('contactInfoInput');
        const contractStartDateInput = document.getElementById('contractStartDate');
        const contractEndDateInput = document.getElementById('contractEndDate');
        const noContractDurationCheckbox = document.getElementById('noContractDurationCheckbox');


        // 選択されたファイルとそれに関連する情報を保持する配列
        // 各オブジェクトは { id: string, file: File, originalFileName: string, zipPath: string, metadata: { [key: string]: string }, isSelectedForBulkEdit: boolean } の形式
        let selectedFiles = [];

        // メタデータ項目の配列 (固定項目 + ユーザー定義項目)
        // 'zipPath' はシステム固定項目で、CSV/TXTファイルに含める
        // 'originalFileName' はメタデータファイルには含めないが、内部で参照用として保持
        let metadataColumns = ['zipPath']; // CSV/TXTに出力する項目

        // ライセンス雛型データ (有料であることを前提とした雛型)
        const licenseTemplates = {
            none: '', // ライセンスファイルを含めない
            custom: '', // カスタムライセンスは初期値が空でユーザーが入力
            default_paid: `データセット利用許諾契約

本データセットの利用には、以下の条件が適用されます。

1.  ライセンスの範囲: 本データセットは、[ライセンシー名]に対して、[利用目的]のために利用することを許可します。本ライセンスは非独占的かつ譲渡不能です。
2.  著作権: 本データセットの著作権は、[著作権者名]に帰属します。
3.  利用許諾内容:
[PERMISSIONS_PLACEHOLDER]
4.  禁止事項:
    * 本ライセンスで明示的に許可されていない利用。
    * 違法な目的での利用。
    * 本データセットの全部または一部を、本ライセンスで明示的に許可されていない方法で、第三者に再配布、販売、サブライセンス供与、または貸与すること。
    * 本データセットを、第三者がアクセス可能な形で公開すること（別途合意がある場合を除く）。
[PROHIBITIONS_PLACEHOLDER]
5.  免責事項: 本データセットは「現状有姿」で提供され、明示的または黙示的を問わず、いかなる保証もありません。提供者は、本データセットの利用または利用不能に起因するいかなる損害についても責任を負いません。
6.  契約期間: [CONTRACT_DURATION_PLACEHOLDER]
7.  準拠法: 本ライセンスは、[国名]の法律に準拠し、同法に従って解釈されるものとします。

本データセットを利用することにより、利用者は本契約の全ての条項に同意したものとみなされます。

[日付]
[提供者名/会社名]
[連絡先情報]
`,
            mit_license: `MITライセンス

Copyright (c) [YEAR] [COPYRIGHT_HOLDER]

本ソフトウェアの使用、複製、変更、結合、公開、配布、サブライセンス供与、販売を、無償で、制限なく許可します。ただし、以下の条件に従うものとします。

上記の著作権表示および本許可表示は、すべての複製または実質的な部分に含まれるものとします。

本ソフトウェアは「現状有姿」で提供され、いかなる保証もありません。著者または著作権者は、本ソフトウェアの使用またはその他の取引に起因するいかなる損害についても責任を負わないものとします。
`,
            apache_license_2_0: `Apacheライセンス
バージョン2.0, 2004年1月

使用、複製、および配布に関する条件

1. 定義
   「ライセンス」とは、本ドキュメントのセクション1から9で定義された、使用、複製、および配布に関する条件を意味します。
   （これは簡略化された表現です。完全なApache 2.0ライセンスのテキストははるかに長く、実際のアプリケーションではそれを使用する必要があります。）

   [COPYRIGHT_HOLDER_PLACEHOLDER]

   ライセンスのコピーは以下で入手できます。
   http://www.apache.org/licenses/LICENSE-2.0

法律で義務付けられている場合、または書面で合意されている場合を除き、ライセンスに基づいて配布されるソフトウェアは、「現状有姿」で配布され、明示的または黙示的を問わず、いかなる保証もありません。ライセンスに基づく許可および制限を規定する特定の言語については、ライセンスを参照してください。
`,
            cc_by_4_0: `クリエイティブ・コモンズ 表示 4.0 国際 パブリック・ライセンス

利用者は、本ライセンスの条件を受諾し同意することにより、許諾された権利を行使できます。

第1条 – 定義
a. 改変されたマテリアルとは、許諾されたマテリアルから派生または基づいており、著作権者の許可を必要とする方法で変更されたマテリアルを意味します。
（これは簡略化された表現です。完全なCC BY 4.0ライセンスのテキストははるかに長く、実際のアプリケーションではそれを使用する必要があります。）

   [COPYRIGHT_HOLDER_PLACEHOLDER]

   ライセンスのコピーは以下で入手できます。
   http://creativecommons.org/licenses/by/4.0/legalcode

これは法的なコードの人間が読める要約です。法的なコード（完全なライセンス）のみが、あなたを拘束する条件の唯一の出典です。
`
        };


        // ユニークなIDを生成するヘルパー関数
        const generateUniqueId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);

        // CSV値の特殊文字をエスケープする関数
        const escapeCsvValue = (value) => {
            if (value === null || value === undefined) {
                return '';
            }
            let stringValue = String(value);
            // 値にカンマ、二重引用符、改行が含まれる場合は二重引用符で囲み、内部の二重引用符は二重にする
            if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n') || stringValue.includes('\r')) {
                return '"' + stringValue.replace(/"/g, '""') + '"';
            }
            return stringValue;
        };

        // 画像リスト、メタデータ項目表示、メタデータテーブル、ZIP内容プレビューをすべてレンダリングする関数
        const renderAllPreviews = () => {
            renderImageList();         // 画像リストのレンダリング
            renderMetadataColumns();   // メタデータ項目表示のレンダリング
            renderMetadataTable();     // メタデータ入力テーブルのレンダリング
            updateZipContentPreview(); // ZIP内容プレビューの更新
            updateSelectAllCheckboxState(); // 「全て選択/解除」チェックボックスの状態を更新
            updateLicenseContent(); // ライセンス内容を更新
        };

        // 画像リストをレンダリングする関数
        const renderImageList = () => {
            imageListContainer.innerHTML = ''; // 既存のリストをクリア
            if (selectedFiles.length === 0) {
                noImageMessage.style.display = 'block';
                downloadZipBtn.disabled = true;
                selectAllImagesCheckbox.disabled = true; // 画像がない場合は無効化
            } else {
                noImageMessage.style.display = 'none';
                downloadZipBtn.disabled = false;
                selectAllImagesCheckbox.disabled = false; // 画像がある場合は有効化

                selectedFiles.forEach(item => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageItemDiv = document.createElement('div');
                        imageItemDiv.classList.add('image-item');
                        imageItemDiv.dataset.id = item.id; // 削除時に使用するIDをデータ属性として保持

                        // 一括選択用チェックボックス
                        const bulkSelectCheckbox = document.createElement('input');
                        bulkSelectCheckbox.type = 'checkbox';
                        bulkSelectCheckbox.classList.add('bulk-select-item-checkbox');
                        bulkSelectCheckbox.checked = item.isSelectedForBulkEdit; // 状態を反映
                        bulkSelectCheckbox.addEventListener('change', (e) => {
                            item.isSelectedForBulkEdit = e.target.checked; // 状態を更新
                            updateSelectAllCheckboxState(); // 全体選択チェックボックスの状態を更新
                        });

                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = item.originalFileName; // 元のファイル名をaltに設定

                        const fileDetailsDiv = document.createElement('div');
                        fileDetailsDiv.classList.add('file-details');

                        const fileNameP = document.createElement('p');
                        fileNameP.textContent = `元のファイル名: ${item.originalFileName}`;

                        // ZIPパス入力行
                        const pathInputRow = document.createElement('div');
                        pathInputRow.classList.add('input-row');
                        const pathLabel = document.createElement('label');
                        pathLabel.textContent = 'ZIP内パス:';
                        const pathInput = document.createElement('input');
                        pathInput.type = 'text';
                        pathInput.value = item.zipPath; // 現在のZIPパスを初期値として設定
                        pathInput.placeholder = '例: folder/image.jpg';
                        // パス入力が変更されたときのイベントリスナー
                        pathInput.addEventListener('input', (e) => {
                            item.zipPath = e.target.value.trim(); // 変更されたパスを更新
                            renderMetadataTable(); // メタデータテーブルを更新
                            updateZipContentPreview(); // ZIP内容プレビューを更新
                        });
                        pathInputRow.appendChild(pathLabel);
                        pathInputRow.appendChild(pathInput);

                        const deleteButton = document.createElement('button');
                        deleteButton.classList.add('delete-btn');
                        deleteButton.textContent = '削除';
                        // 削除ボタンがクリックされたときのイベントリスナー
                        deleteButton.addEventListener('click', () => {
                            // 選択されたファイルリストからこの画像を削除
                            selectedFiles = selectedFiles.filter(f => f.id !== item.id);
                            renderAllPreviews(); // すべてのプレビューを再レンダリング
                            statusMessage.textContent = ''; // ステータスメッセージをクリア
                        });

                        imageItemDiv.appendChild(bulkSelectCheckbox); // チェックボックスを追加
                        imageItemDiv.appendChild(img);
                        fileDetailsDiv.appendChild(fileNameP);
                        fileDetailsDiv.appendChild(pathInputRow);
                        imageItemDiv.appendChild(fileDetailsDiv);
                        imageItemDiv.appendChild(deleteButton);
                        imageListContainer.appendChild(imageItemDiv);
                    };
                    // 画像ファイルの読み込みを開始し、成功したらonloadが呼ばれる
                    reader.readAsDataURL(item.file);
                });
            }
        };

        // 「全て選択/解除」チェックボックスの状態を更新する関数
        const updateSelectAllCheckboxState = () => {
            if (selectedFiles.length === 0) {
                selectAllImagesCheckbox.checked = false;
                selectAllImagesCheckbox.indeterminate = false; // 不確定状態を解除
                return;
            }
            const allSelected = selectedFiles.every(item => item.isSelectedForBulkEdit);
            const anySelected = selectedFiles.some(item => item.isSelectedForBulkEdit);

            if (allSelected) {
                selectAllImagesCheckbox.checked = true;
                selectAllImagesCheckbox.indeterminate = false;
            } else if (anySelected) {
                selectAllImagesCheckbox.checked = false;
                selectAllImagesCheckbox.indeterminate = true; // 一部選択状態
            } else {
                selectAllImagesCheckbox.checked = false;
                selectAllImagesCheckbox.indeterminate = false;
            }
        };

        // メタデータ項目表示をレンダリングする関数
        const renderMetadataColumns = () => {
            currentColumnsDisplay.innerHTML = ''; // 既存の表示をクリア
            // 'zipPath' は固定項目として表示しない、ユーザー定義項目のみ表示
            const userDefinedColumns = metadataColumns.filter(col => col !== 'zipPath');

            if (userDefinedColumns.length === 0) {
                columnConfigMessage.textContent = 'まだカスタム項目がありません。';
            } else {
                columnConfigMessage.textContent = '現在のカスタム項目:';
                userDefinedColumns.forEach(column => {
                    const columnTag = document.createElement('div');
                    columnTag.classList.add('column-tag');
                    columnTag.textContent = column;

                    const removeBtn = document.createElement('button');
                    removeBtn.classList.add('remove-column-btn');
                    removeBtn.textContent = 'x';
                    removeBtn.title = `${column} 項目を削除`;
                    removeBtn.addEventListener('click', () => {
                        removeCustomColumn(column);
                    });

                    columnTag.appendChild(removeBtn);
                    currentColumnsDisplay.appendChild(columnTag);
                });
            }
        };

        // メタデータ入力テーブルをレンダリングする関数
        const renderMetadataTable = () => {
            metadataTable.innerHTML = ''; // 既存のテーブルをクリア

            if (selectedFiles.length === 0) {
                noMetadataMessage.style.display = 'block';
                return;
            } else {
                noMetadataMessage.style.display = 'none';
            }

            // ヘッダー行の作成
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            // テーブル表示用の項目リスト (元のファイル名を含めない)
            const displayColumns = [...metadataColumns]; // originalFileName を含めない

            displayColumns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column === 'zipPath' ? 'ZIP内パス' : column; // 表示名を調整
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            metadataTable.appendChild(thead);

            // データ行の作成
            const tbody = document.createElement('tbody');
            selectedFiles.forEach(item => {
                const dataRow = document.createElement('tr');
                displayColumns.forEach(column => {
                    const td = document.createElement('td');
                    let value = '';

                    if (column === 'zipPath') {
                        value = item.zipPath;
                        td.classList.add('fixed-column'); // 固定列のスタイル
                        td.textContent = value; // テキストとして表示
                    } else {
                        // ユーザー定義項目
                        value = item.metadata[column] || ''; // 値がなければ空文字列
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = value;
                        input.placeholder = `入力 (${column})`;
                        input.dataset.itemId = item.id;
                        input.dataset.columnName = column;
                        input.addEventListener('input', (e) => {
                            const itemId = e.target.dataset.itemId;
                            const colName = e.target.dataset.columnName;
                            const fileItem = selectedFiles.find(f => f.id === itemId);
                            if (fileItem) {
                                fileItem.metadata[colName] = e.target.value;
                            }
                        });
                        td.appendChild(input);
                    }
                    dataRow.appendChild(td);
                });
                tbody.appendChild(dataRow);
            });
            metadataTable.appendChild(tbody);
        };

        // ZIP内容プレビューを更新する関数
        const updateZipContentPreview = () => {
            zipContentPreview.innerHTML = ''; // 既存のリストをクリア
            if (selectedFiles.length === 0) {
                noZipContentMessage.style.display = 'block';
            } else {
                noZipContentMessage.style.display = 'none';
                // ZIPパスでソートして表示すると見やすい
                const sortedPaths = selectedFiles
                    .map(item => item.zipPath || item.originalFileName) // zipPathが空の場合はoriginalFileNameを使用
                    .sort((a, b) => {
                        // フォルダとファイルを区別してソート（例: folder/a.jpg, folder/b.jpg, file.jpg）
                        const isAFolder = a.endsWith('/');
                        const isBFolder = b.endsWith('/');
                        if (isAFolder && !isBFolder) return -1;
                        if (!isAFolder && isBFolder) return 1;
                        return a.localeCompare(b);
                    });

                sortedPaths.forEach(displayPath => {
                    const listItem = document.createElement('li');
                    listItem.textContent = displayPath;
                    zipContentPreview.appendChild(listItem);
                });

                // 情報解析ファイルもプレビューに追加
                const metadataFileName = getMetadataFileName();
                const metadataListItem = document.createElement('li');
                metadataListItem.classList.add('metadata-file'); // メタデータファイル用のクラス
                metadataListItem.textContent = metadataFileName;
                zipContentPreview.appendChild(metadataListItem);
            }

            // ライセンスファイルもプレビューに追加
            const licenseFileName = licenseFileNameInput.value.trim();
            const licenseContent = licenseContentTextarea.value.trim();
            if (licenseFileName && licenseContent && licenseTemplateSelect.value !== 'none') { // ライセンステンプレートが「含めない」以外の場合に表示
                const licenseListItem = document.createElement('li');
                licenseListItem.classList.add('license-file'); // ライセンスファイル用のクラス
                licenseListItem.textContent = licenseFileName;
                zipContentPreview.appendChild(licenseListItem);
            }
        };

        // メタデータファイル名を取得する関数
        const getMetadataFileName = () => {
            const format = document.querySelector('input[name="metadataFormat"]:checked').value;
            return `metadata.${format}`;
        };

        // メタデータファイルの内容を生成する関数
        const generateMetadataFileContent = () => {
            let content = '';
            // ヘッダー行
            content += metadataColumns.map(col => escapeCsvValue(col)).join(',') + '\n';

            // データ行
            selectedFiles.forEach(item => {
                const rowValues = metadataColumns.map(column => {
                    if (column === 'zipPath') {
                        return escapeCsvValue(item.zipPath || item.originalFileName);
                    } else {
                        return escapeCsvValue(item.metadata[column] || '');
                    }
                });
                content += rowValues.join(',') + '\n';
            });
            return content;
        };

        // ファイルが選択されたときの処理
        imageInput.addEventListener('change', (event) => {
            statusMessage.textContent = ''; // ステータスメッセージをクリア
            const newFiles = Array.from(event.target.files);

            newFiles.forEach(file => {
                if (file.type.startsWith('image/')) {
                    // 各ファイルにユニークなIDとデフォルトのZIPパス、空のメタデータオブジェクトを割り当てて追加
                    const newFileItem = {
                        id: generateUniqueId(),
                        file: file,
                        originalFileName: file.name, // 元のファイル名を保持
                        zipPath: file.name, // デフォルトは元のファイル名（ZIPのルートに配置）
                        metadata: {}, // 追加情報の初期値は空オブジェクト
                        isSelectedForBulkEdit: false // 一括編集の選択状態を初期化
                    };
                    // 現在定義されているカスタム項目を新しいファイルアイテムのメタデータに初期化
                    // metadataColumnsから固定項目('zipPath')を除外してループ
                    metadataColumns.filter(col => col !== 'zipPath').forEach(col => {
                        newFileItem.metadata[col] = '';
                    });
                    selectedFiles.push(newFileItem);
                }
            });
            // すべてのプレビューを再レンダリング
            renderAllPreviews();
            // ファイル選択後、inputの値をクリアして、同じファイルを再度選択できるようにする
            imageInput.value = ''; // これにより、同じファイルを再度選択してもchangeイベントが発火する
        });

        // カスタム項目を追加するボタンのイベントリスナー
        addColumnBtn.addEventListener('click', () => {
            const newColumnName = newColumnNameInput.value.trim();
            if (!newColumnName) {
                columnConfigMessage.textContent = '項目名を入力してください。';
                columnConfigMessage.style.color = '#e06c75';
                return;
            }
            // 既存の項目名と重複しないかチェック（固定項目も含む）
            if (metadataColumns.includes(newColumnName) || newColumnName === 'originalFileName') {
                columnConfigMessage.textContent = `項目「${newColumnName}」は既に存在するか、予約語です。`;
                columnConfigMessage.style.color = '#e06c75';
                return;
            }

            metadataColumns.push(newColumnName); // 新しい項目を追加
            // 既存のすべてのファイルアイテムのメタデータに新しい項目を追加し初期化
            selectedFiles.forEach(item => {
                item.metadata[newColumnName] = '';
            });

            newColumnNameInput.value = ''; // 入力フィールドをクリア
            columnConfigMessage.textContent = `項目「${newColumnName}」を追加しました。`;
            columnConfigMessage.style.color = '#98c379';
            renderAllPreviews(); // すべてのプレビューを再レンダリング
        });

        // カスタム項目を削除する関数
        const removeCustomColumn = (columnToRemove) => {
            metadataColumns = metadataColumns.filter(col => col !== columnToRemove); // 項目を削除
            // 既存のすべてのファイルアイテムのメタデータから削除された項目を削除
            selectedFiles.forEach(item => {
                delete item.metadata[columnToRemove];
            });
            columnConfigMessage.textContent = `項目「${columnToRemove}」を削除しました。`;
            columnConfigMessage.style.color = '#e06c75';
            renderAllPreviews(); // すべてのプレビューを再レンダリング
        };

        // 一括フォルダ指定を適用するボタンのイベントリスナー
        applyBulkFolderBtn.addEventListener('click', () => {
            const bulkPath = bulkFolderPathInput.value.trim();
            let normalizedBulkPath = bulkPath;

            if (normalizedBulkPath) {
                // パスがスラッシュで終わっていない場合、追加する
                if (!normalizedBulkPath.endsWith('/') && !normalizedBulkPath.endsWith('\\')) {
                    normalizedBulkPath += '/';
                }
                // Windowsの\を/に変換
                normalizedBulkPath = normalizedPath.replace(/\\/g, '/');
            }

            // 選択されているファイルのみを対象にする
            const filesToUpdate = selectedFiles.filter(item => item.isSelectedForBulkEdit);

            if (filesToUpdate.length === 0) {
                statusMessage.textContent = '一括指定する画像が選択されていません。';
                statusMessage.style.color = '#e06c75';
                return;
            }

            filesToUpdate.forEach(item => {
                // 既存のフォルダパスを削除し、新しい一括パスの直下にファイル名を配置
                item.zipPath = normalizedBulkPath + item.originalFileName;
            });

            statusMessage.textContent = '選択された画像に一括フォルダ指定を適用しました。';
            statusMessage.style.color = '#98c379';
            renderAllPreviews(); // UIを更新
        });

        // 「全て選択 / 全て解除」チェックボックスの状態を更新する関数
        selectAllImagesCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            selectedFiles.forEach(item => {
                item.isSelectedForBulkEdit = isChecked;
            });
            // チェックボックスの状態変更が反映されるように再レンダリングは不要だが、
            // 念のためrenderImageListを呼び出してチェックボックスの状態を更新
            renderImageList();
            updateSelectAllCheckboxState(); // 親のチェックボックスの状態も更新
        });


        // ライセンス内容を生成する関数
        const generateLicenseContent = () => {
            const selectedTemplate = licenseTemplateSelect.value;
            let content = '';

            // 提供者名と連絡先が入力されているかチェック
            const providerName = datasetProviderInput.value.trim();
            const contactInfo = contactInfoInput.value.trim();
            const currentYear = new Date().getFullYear();

            if (selectedTemplate === 'none') {
                return '';
            } else if (selectedTemplate === 'custom') {
                return licenseContentTextarea.value; // ユーザーが入力した内容をそのまま返す
            } else if (selectedTemplate === 'default_paid') {
                content = licenseTemplates.default_paid;

                let permissionsText = [];
                const selectedAITrainingOption = aiTrainingPermissionSelect.value;

                // 生成AI学習への利用に関する許可
                if (selectedAITrainingOption === 'ai_learning') {
                    permissionsText.push("    - 生成AI学習への利用を許可します。");
                } else if (selectedAITrainingOption === 'ai_analysis') {
                    permissionsText.push("    - 生成AI学習やその他情報解析への利用を許可します。");
                } else if (selectedAITrainingOption === 'ai_minor_use') {
                    permissionsText.push("    - 生成AI学習やその他情報解析への利用及びその結果を表示するための軽微利用を許可します。");
                }

                if (requireAIAttributionCheckbox.checked) { // 常に有効なので、チェック状態のみ確認
                    permissionsText.push("        - 生成AI生成物に当該データセットを使用したことを明記することを義務付けます。");
                }

                if (allowCommercialUseCheckbox.checked) {
                    permissionsText.push("    - 商用利用を許可します。");
                } else {
                    permissionsText.push("    - 商用利用は許可されません。");
                }

                if (allowModificationCheckbox.checked) {
                    permissionsText.push("    - データセットの改変を許可します。");
                } else {
                    permissionsText.push("    - データセットの改変は許可されません。");
                }

                if (allowRedistributionCheckbox.checked) {
                    permissionsText.push("    - データセットの再配布を許可します（別途契約がない限り、無償での再配布に限る場合があります）。");
                } else {
                    permissionsText.push("    - データセットの再配布は許可されません。");
                }
                
                if (requireServiceCreditCheckbox.checked) {
                    permissionsText.push("    - 当該データセットを利用したサービスへのクレジット表記を義務付けます。");
                } else {
                    permissionsText.push("    - 当該データセットを利用したサービスへのクレジット表記は義務付けられません。");
                }


                content = content.replace('[PERMISSIONS_PLACEHOLDER]', permissionsText.join('\n'));

                let prohibitionsText = [];
                // 禁止事項
                if (allowNonCommercialUseOnlyCheckbox.checked) {
                    prohibitionsText.push("    * 非享受利用以外の利用を禁止します。");
                }
                if (prohibitReligiousPoliticalCheckbox.checked) {
                    prohibitionsText.push("    * 宗教、政治関係の利用を禁止します。");
                }
                if (prohibitEroticGrotesqueCheckbox.checked) {
                    prohibitionsText.push("    * エロ、グロテスク関係のAI生成への利用を禁止します。");
                }
                if (prohibitThirdPartyReproductionCheckbox.checked) {
                    if (selectedAITrainingOption === 'ai_minor_use') {
                        prohibitionsText.push("    * 当該データセットを利用したAI生成物に当該データセット内著作物のすべてまたは一部の複製物が含まれていた場合、第三者への提供を禁止します（AI事業者の責任とします）ただし軽微利用を除きます。");
                    } else {
                        prohibitionsText.push("    * 当該データセットを利用したAI生成物に当該データセット内著作物のすべてまたは一部の複製物が含まれていた場合、第三者への提供を禁止します（AI事業者の責任とします）。");
                    }
                }

                // 禁止事項のプレースホルダーを置き換える。禁止事項がなければ空行を削除
                if (prohibitionsText.length > 0) {
                    content = content.replace('[PROHIBITIONS_PLACEHOLDER]', '\n' + prohibitionsText.join('\n'));
                } else {
                    content = content.replace('[PROHIBITIONS_PLACEHOLDER]', ''); // 禁止事項がなければプレースホルダーを削除
                }


                // 契約期間のプレースホルダーを置き換える
                let contractDurationText = '';
                if (noContractDurationCheckbox.checked) {
                    contractDurationText = '期間の定めなし'; // 簡潔な表現に修正
                } else {
                    const startDate = contractStartDateInput.value;
                    const endDate = contractEndDateInput.value;
                    if (startDate && endDate) {
                        contractDurationText = `${startDate}から${endDate}まで`;
                    } else if (startDate) {
                        contractDurationText = `${startDate}から別途合意された期間まで`;
                    } else if (endDate) {
                        contractDurationText = `別途合意された期間から${endDate}まで`;
                    } else {
                        contractDurationText = '別途契約に定める';
                    }
                }
                content = content.replace('[CONTRACT_DURATION_PLACEHOLDER]', contractDurationText);


                // その他のプレースホルダーも置き換える
                const currentDate = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
                content = content.replace(/\[ライセンシー名\]/g, '貴社/貴殿'); // 仮のプレースホルダー
                content = content.replace(/\[利用目的\]/g, '本ライセンスの範囲内'); // 仮のプレースホルダー
                // 提供者名や連絡先が空の場合、空文字列で置き換え
                content = content.replace(/\[著作権者名\]/g, providerName || '');
                content = content.replace(/\[国名\]/g, '日本国'); // 仮のプレースホルダー
                content = content.replace(/\[日付\]/g, currentDate);
                content = content.replace(/\[提供者名\/会社名\]/g, providerName || '');
                content = content.replace(/\[連絡先情報\]/g, contactInfo || '');

                return content;
            } else if (selectedTemplate === 'default_free') {
                const selectedFreeLicense = freeLicenseSelect.value;
                let licenseText = licenseTemplates[selectedFreeLicense];

                // 無料ライセンスのプレースホルダーを置き換える
                licenseText = licenseText.replace(/\[YEAR\]/g, currentYear);
                licenseText = licenseText.replace(/\[COPYRIGHT_HOLDER\]/g, providerName || '著作権者'); // 提供者名がなければ「著作権者」
                licenseText = licenseText.replace(/\[COPYRIGHT_HOLDER_PLACEHOLDER\]/g, providerName || '著作権者');

                return licenseText;
            }
            return '';
        };

        // ライセンス雛型選択のイベントリスナー
        licenseTemplateSelect.addEventListener('change', () => {
            const selectedTemplate = licenseTemplateSelect.value;

            // まずすべてのオプションを非表示・無効化
            licenseContentTextarea.value = '';
            licenseContentTextarea.disabled = true;
            licenseFileNameInput.value = '';
            permissionOptionsDiv.style.display = 'none';
            freeLicenseOptionsDiv.style.display = 'none';
            
            // 提供者、連絡先、契約期間の親グループと子要素をすべて非表示・無効化
            providerContactDurationGroup.style.display = 'none';
            datasetProviderGroup.style.display = 'none'; // データセット提供者名/会社名のグループを非表示
            contactInfoGroup.style.display = 'none';
            contractDurationGroup.style.display = 'none';
            datasetProviderInput.disabled = true;
            contactInfoInput.disabled = true;
            contractStartDateInput.disabled = true;
            contractEndDateInput.disabled = true;
            noContractDurationCheckbox.disabled = true;


            // 権限チェックボックスをすべて無効化
            aiTrainingPermissionSelect.disabled = true;
            requireAIAttributionCheckbox.disabled = true;
            allowCommercialUseCheckbox.disabled = true;
            allowRedistributionCheckbox.disabled = true;
            allowModificationCheckbox.disabled = true;
            allowNonCommercialUseOnlyCheckbox.disabled = true;
            requireServiceCreditCheckbox.disabled = true;
            prohibitReligiousPoliticalCheckbox.disabled = true;
            prohibitEroticGrotesqueCheckbox.disabled = true;
            prohibitThirdPartyReproductionCheckbox.disabled = true;


            if (selectedTemplate === 'none') {
                // 何もしない
            } else if (selectedTemplate === 'custom') {
                licenseContentTextarea.disabled = false;
                licenseFileNameInput.value = 'LICENSE.txt';
                
                // カスタムの場合、すべての入力欄を非表示
                providerContactDurationGroup.style.display = 'none'; // 親グループを非表示
                datasetProviderGroup.style.display = 'none'; // データセット提供者名/会社名のグループを非表示
                contactInfoGroup.style.display = 'none'; // 連絡先は非表示
                contractDurationGroup.style.display = 'none'; // 契約期間は非表示
                datasetProviderInput.disabled = true;
                contactInfoInput.disabled = true;
                contractStartDateInput.disabled = true;
                contractEndDateInput.disabled = true;
                noContractDurationCheckbox.disabled = true;

            } else if (selectedTemplate === 'default_paid') {
                licenseContentTextarea.disabled = false;
                licenseFileNameInput.value = 'LICENSE.txt';
                permissionOptionsDiv.style.display = 'flex';
                
                // デフォルト有料の場合、提供者名、連絡先、契約期間の全てを表示・有効化
                providerContactDurationGroup.style.display = 'block';
                datasetProviderGroup.style.display = 'flex'; // データセット提供者名/会社名のグループを表示
                contactInfoGroup.style.display = 'flex';
                contractDurationGroup.style.display = 'flex';
                datasetProviderInput.disabled = false;
                contactInfoInput.disabled = false;
                contractStartDateInput.disabled = noContractDurationCheckbox.checked;
                contractEndDateInput.disabled = noContractDurationCheckbox.checked;
                noContractDurationCheckbox.disabled = false;

                // 権限チェックボックスを有効化
                aiTrainingPermissionSelect.disabled = false;
                requireAIAttributionCheckbox.disabled = false; // 常に有効化
                allowCommercialUseCheckbox.disabled = false;
                allowRedistributionCheckbox.disabled = false;
                allowModificationCheckbox.disabled = false;
                allowNonCommercialUseOnlyCheckbox.disabled = false; // aiTrainingPermissionSelect の値に依存
                requireServiceCreditCheckbox.disabled = false;
                prohibitReligiousPoliticalCheckbox.disabled = false;
                prohibitEroticGrotesqueCheckbox.disabled = false;
                prohibitThirdPartyReproductionCheckbox.disabled = false;

                // aiTrainingPermissionSelect の現在の値に基づいて allowNonCommercialUseOnlyCheckbox を制御
                const currentAITrainingOption = aiTrainingPermissionSelect.value;
                if (currentAITrainingOption === 'ai_minor_use') {
                    allowNonCommercialUseOnlyCheckbox.checked = false;
                    allowNonCommercialUseOnlyCheckbox.disabled = true;
                } else {
                    allowNonCommercialUseOnlyCheckbox.disabled = false;
                }

            } else if (selectedTemplate === 'default_free') {
                licenseContentTextarea.disabled = false;
                licenseFileNameInput.value = 'LICENSE.txt';
                freeLicenseOptionsDiv.style.display = 'flex';
                
                // デフォルト無料の場合、提供者名のみ表示・有効化
                providerContactDurationGroup.style.display = 'block';
                datasetProviderGroup.style.display = 'flex'; // データセット提供者名/会社名のグループを表示
                datasetProviderInput.disabled = false;
                contactInfoGroup.style.display = 'none'; // 連絡先は非表示
                contractDurationGroup.style.display = 'none'; // 契約期間は非表示
                contactInfoInput.disabled = true;
                contractStartDateInput.disabled = true;
                contractEndDateInput.disabled = true;
                noContractDurationCheckbox.disabled = true;

                // 無料ライセンスの場合、権限チェックボックスは無効化
                aiTrainingPermissionSelect.disabled = true;
                requireAIAttributionCheckbox.disabled = true;
                allowCommercialUseCheckbox.disabled = true;
                allowRedistributionCheckbox.disabled = true;
                allowModificationCheckbox.disabled = true;
                allowNonCommercialUseOnlyCheckbox.disabled = true;
                requireServiceCreditCheckbox.disabled = true;
                prohibitReligiousPoliticalCheckbox.disabled = true;
                prohibitEroticGrotesqueCheckbox.disabled = true;
                prohibitThirdPartyReproductionCheckbox.disabled = true;

                // デフォルトでMITライセンスを選択
                freeLicenseSelect.value = 'mit_license';
            }
            updateLicenseContent(); // ライセンス内容を更新
            updateZipContentPreview(); // ZIP内容プレビューを更新
        });

        // 無料ライセンス選択のイベントリスナー
        freeLicenseSelect.addEventListener('change', () => {
            updateLicenseContent();
            updateZipContentPreview();
        });


        // 生成AI学習許可ドロップダウンのイベントリスナー
        aiTrainingPermissionSelect.addEventListener('change', () => {
            const selectedOption = aiTrainingPermissionSelect.value;
            // 「軽微利用」が選択された場合、「非享受利用以外の利用を禁止する」を無効化し、チェックを外す
            if (selectedOption === 'ai_minor_use') {
                allowNonCommercialUseOnlyCheckbox.checked = false;
                allowNonCommercialUseOnlyCheckbox.disabled = true;
            } else {
                // 商用利用が許可されていない場合のみ有効化
                if (!allowCommercialUseCheckbox.checked) {
                    allowNonCommercialUseOnlyCheckbox.disabled = false;
                }
            }
            // requireAIAttributionCheckbox は常に有効なので、ここでは制御しない
            updateLicenseContent();
            updateZipContentPreview();
        });


        // 権限チェックボックスのイベントリスナー
        requireAIAttributionCheckbox.addEventListener('change', () => { updateLicenseContent(); updateZipContentPreview(); });
        allowCommercialUseCheckbox.addEventListener('change', () => {
            // 商用利用を許可する場合、非享受利用のみを許可するチェックボックスは無効化
            if (allowNonCommercialUseOnlyCheckbox.checked) { // 非享受利用のみがチェックされている場合は、商用利用を無効化
                allowCommercialUseCheckbox.checked = false;
                allowCommercialUseCheckbox.disabled = true;
            } else {
                allowCommercialUseCheckbox.disabled = false;
            }
            updateLicenseContent(); updateZipContentPreview();
        });
        allowRedistributionCheckbox.addEventListener('change', () => { updateLicenseContent(); updateZipContentPreview(); });
        allowModificationCheckbox.addEventListener('change', () => { updateLicenseContent(); updateZipContentPreview(); });

        // 新しい利用許諾内容チェックボックスのイベントリスナー
        allowNonCommercialUseOnlyCheckbox.addEventListener('change', () => {
            // 非享受利用のみを許可する場合、商用利用を許可するチェックボックスは無効化
            if (allowNonCommercialUseOnlyCheckbox.checked) {
                allowCommercialUseCheckbox.checked = false;
                allowCommercialUseCheckbox.disabled = true;
            } else {
                allowCommercialUseCheckbox.disabled = false;
            }
            updateLicenseContent(); updateZipContentPreview();
        });
        requireServiceCreditCheckbox.addEventListener('change', () => { updateLicenseContent(); updateZipContentPreview(); });
        prohibitReligiousPoliticalCheckbox.addEventListener('change', () => { updateLicenseContent(); updateZipContentPreview(); });
        prohibitEroticGrotesqueCheckbox.addEventListener('change', () => { updateLicenseContent(); updateZipContentPreview(); });
        prohibitThirdPartyReproductionCheckbox.addEventListener('change', () => { updateLicenseContent(); updateZipContentPreview(); });


        // 契約期間設定関連のイベントリスナー
        contractStartDateInput.addEventListener('input', () => { updateLicenseContent(); updateZipContentPreview(); });
        contractEndDateInput.addEventListener('input', () => { updateLicenseContent(); updateZipContentPreview(); });
        noContractDurationCheckbox.addEventListener('change', () => {
            const isDisabled = noContractDurationCheckbox.checked;
            contractStartDateInput.disabled = isDisabled;
            contractEndDateInput.disabled = isDisabled;
            if (isDisabled) {
                contractStartDateInput.value = ''; // 期間なしの場合、日付をクリア
                contractEndDateInput.value = '';
            }
            updateLicenseContent();
            updateZipContentPreview();
        });

        // データセット提供者、連絡先情報のイベントリスナー
        datasetProviderInput.addEventListener('input', () => { updateLicenseContent(); updateZipContentPreview(); });
        contactInfoInput.addEventListener('input', () => { updateLicenseContent(); updateZipContentPreview(); });


        // ライセンス内容をテキストエリアに反映する関数
        const updateLicenseContent = () => {
            licenseContentTextarea.value = generateLicenseContent();
        };


        // ライセンスファイル名入力欄のイベントリスナー
        licenseFileNameInput.addEventListener('input', () => {
            updateZipContentPreview(); // ZIP内容プレビューを更新
        });

        // ライセンス内容テキストエリアのイベントリスナー
        licenseContentTextarea.addEventListener('input', () => {
            // カスタムライセンスの場合のみ、手動入力された内容を反映
            // デフォルト有料ライセンスの場合も手動入力された内容を反映するように変更
            if (licenseTemplateSelect.value === 'custom' || licenseTemplateSelect.value === 'default_paid' || licenseTemplateSelect.value === 'default_free') {
                updateZipContentPreview(); // ZIP内容プレビューを更新
            }
        });


        // 情報解析ファイル形式のラジオボタンが変更されたときの処理
        formatCsvRadio.addEventListener('change', updateZipContentPreview);
        formatTxtRadio.addEventListener('change', updateZipContentPreview);


        // ZIPファイル作成＆ダウンロードボタンがクリックされたときの処理
        downloadZipBtn.addEventListener('click', async () => {
            if (selectedFiles.length === 0) {
                statusMessage.textContent = 'ファイルが選択されていません。';
                return;
            }

            downloadZipBtn.disabled = true; // ボタンを無効化
            loadingSpinner.style.display = 'block'; // ローディングスピナーを表示
            statusMessage.textContent = 'ZIPファイルを作成中です...'; // ステータスメッセージを更新

            const zip = new JSZip(); // 新しいJSZipインスタンスを作成

            // 各画像をZIPに追加
            for (const item of selectedFiles) {
                if (item.file.type.startsWith('image/')) {
                    const arrayBuffer = await item.file.arrayBuffer(); // ファイルの内容をArrayBufferとして非同期で読み込む
                    // ユーザーが指定したzipPathを使用。空の場合はoriginalFileNameを使用
                    const pathInZip = item.zipPath || item.originalFileName;
                    // パス区切り文字を正規化（Windowsの\も/に変換）
                    const normalizedPath = pathInZip.replace(/\\/g, '/');
                    zip.file(normalizedPath, arrayBuffer); // 指定されたパスでZIPに追加
                }
            }

            // 情報解析ファイルを生成してZIPに追加
            const metadataContent = generateMetadataFileContent();
            const metadataFileName = getMetadataFileName();
            zip.file(metadataFileName, metadataContent);

            // ライセンスファイルが設定されていればZIPに追加
            const licenseContent = generateLicenseContent(); // 最新のライセンス内容を取得
            const licenseFileName = licenseFileNameInput.value.trim();
            if (licenseContent && licenseFileName && licenseTemplateSelect.value !== 'none') {
                zip.file(licenseFileName, licenseContent);
            }

            // ZIPファイルを生成してダウンロード
            zip.generateAsync({ type: "blob" }) // Blob形式でZIPファイルを非同期生成
                .then(function (content) {
                    saveAs(content, "ai_training_data.zip"); // FileSaver.jsを使ってダウンロード
                    statusMessage.textContent = 'ZIPファイルのダウンロードが完了しました！';
                })
                .catch(error => {
                    statusMessage.textContent = 'ZIPファイルの作成中にエラーが発生しました: ' + error.message;
                    console.error('ZIP creation error:', error);
                })
                .finally(() => {
                    loadingSpinner.style.display = 'none'; // スピナーを非表示
                    downloadZipBtn.disabled = false; // ボタンを再度有効化
                });
        });

        // 初期表示時にすべてのプレビューをレンダリング
        renderAllPreviews();
        // ページ読み込み時にデフォルトのライセンス雛型を適用
        licenseTemplateSelect.dispatchEvent(new Event('change'));
    </script>
</body>
</html>
